<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velvera - Вашият козметичен салон</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Playfair Display', serif; }
        html { scroll-behavior: smooth; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #fff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <!-- Header and Navigation -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-stone-900 font-serif">Velvera</a>
            <div class="hidden md:flex space-x-8">
                <a href="#services" class="text-stone-600 hover:text-orange-500 transition duration-300">Услуги</a>
                <a href="#about" class="text-stone-600 hover:text-orange-500 transition duration-300">За нас</a>
                <a href="#team" class="text-stone-600 hover:text-orange-500 transition duration-300">Екип</a>
                <a href="#gallery" class="text-stone-600 hover:text-orange-500 transition duration-300">Галерия</a>
            </div>
            <a href="#booking" class="hidden md:block bg-black text-white px-6 py-2 rounded-lg hover:bg-stone-800 transition duration-300">Запази час</a>
            <button id="mobile-menu-button" class="md:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </nav>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4 space-y-2">
            <a href="#services" class="block text-stone-600 hover:text-orange-500 transition duration-300">Услуги</a>
            <a href="#about" class="block text-stone-600 hover:text-orange-500 transition duration-300">За нас</a>
            <a href="#team" class="block text-stone-600 hover:text-orange-500 transition duration-300">Екип</a>
            <a href="#gallery" class="block text-stone-600 hover:text-orange-500 transition duration-300">Галерия</a>
            <a href="#booking" class="block bg-black text-white text-center mt-2 px-6 py-2 rounded-lg hover:bg-stone-800 transition duration-300">Запази час</a>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="py-20 md:py-32 bg-white">
            <div class="container mx-auto px-6 text-center">
                <h1 class="text-4xl md:text-6xl font-bold text-stone-900 mb-4">Открийте своята перфектна визия</h1>
                <p class="text-lg text-stone-600 max-w-2xl mx-auto mb-8">Преображението е само началото. Изживейте грижа от ново поколение, която подчертава вашата естествена красота.</p>
                <a href="#booking" class="bg-black text-white px-8 py-3 rounded-lg hover:bg-stone-800 transition duration-300 text-lg">Запазете своя час сега</a>
                <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                    <img loading="lazy" src="https://placehold.co/400x500/f2e8e3/333?text=Процедура+за+лице" alt="Процедура за лице" class="rounded-lg shadow-lg w-full h-auto object-cover">
                    <img loading="lazy" src="https://placehold.co/400x500/e6ddd6/333?text=Релаксиращ+масаж" alt="Жена на масаж" class="rounded-lg shadow-lg w-full h-auto object-cover mt-0 md:-mt-8">
                    <img loading="lazy" src="https://placehold.co/400x500/f0e9e5/333?text=Перфектен+маникюр" alt="Маникюр" class="rounded-lg shadow-lg w-full h-auto object-cover">
                </div>
            </div>
        </section>

        <!-- Services Section -->
        <section id="services" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <span class="text-orange-500 font-semibold">Услуги</span>
                    <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mt-2">Първокласни услуги, създадени за вас</h2>
                </div>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-lg shadow-md text-center">
                        <h3 class="text-xl font-bold mb-2">Грижа за лице и тяло</h3>
                        <p class="text-stone-600">Подмладяващи и релаксиращи терапии за сияйна кожа и пълен релакс.</p>
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-md text-center">
                        <h3 class="text-xl font-bold mb-2">Маникюр и педикюр</h3>
                        <p class="text-stone-600">Пълна грижа за вашите ръце и крака, за да се чувствате и изглеждате перфектно.</p>
                    </div>
                    <div class="bg-white p-8 rounded-lg shadow-md text-center">
                        <h3 class="text-xl font-bold mb-2">Епилация и грижа за вежди</h3>
                        <p class="text-stone-600">Професионални услуги за гладка кожа и перфектно оформени вежди и мигли.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Us Section -->
        <section id="about" class="py-20 bg-white">
            <div class="container mx-auto px-6 grid md:grid-cols-2 gap-12 items-center">
                <div>
                    <span class="text-orange-500 font-semibold">Защо да изберете нас</span>
                    <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mt-2 mb-4">Защо Velvera е правилният избор за вашата красота</h2>
                    <ul class="space-y-4">
                        <li class="flex items-start">
                            <span class="text-orange-500 mr-3 mt-1">&#10003;</span>
                            <div><strong class="block">Експертиза:</strong> Прецизни процедури от квалифицирани професионалисти.</div>
                        </li>
                        <li class="flex items-start">
                             <span class="text-orange-500 mr-3 mt-1">&#10003;</span>
                            <div><strong class="block">Качество:</strong> Най-добрите продукти за трайни резултати.</div>
                        </li>
                        <li class="flex items-start">
                             <span class="text-orange-500 mr-3 mt-1">&#10003;</span>
                            <div><strong class="block">Персонализация:</strong> Индивидуален подход към всеки клиент.</div>
                        </li>
                    </ul>
                </div>
                <div>
                    <img loading="lazy" src="https://placehold.co/600x450/f2e8e3/333?text=Салон+Velvera" alt="Интериор на салона" class="rounded-lg shadow-lg">
                </div>
            </div>
        </section>
        
        <!-- Team Section -->
        <section id="team" class="py-20">
            <div class="container mx-auto px-6 text-center">
                <span class="text-orange-500 font-semibold">Нашият екип</span>
                <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mt-2 mb-12">Запознайте се с експертите зад магията</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                    <div class="text-center">
                        <img loading="lazy" src="https://placehold.co/300x300/e6ddd6/333?text=Елена" alt="Елена" class="rounded-full w-32 h-32 mx-auto mb-4 shadow-md">
                        <h3 class="font-bold text-lg">Елена Петрова</h3>
                        <p class="text-stone-600">Топ козметик</p>
                    </div>
                     <div class="text-center">
                        <img loading="lazy" src="https://placehold.co/300x300/f0e9e5/333?text=Мария" alt="Мария" class="rounded-full w-32 h-32 mx-auto mb-4 shadow-md">
                        <h3 class="font-bold text-lg">Мария Иванова</h3>
                        <p class="text-stone-600">Специалист по епилация</p>
                    </div>
                     <div class="text-center">
                        <img loading="lazy" src="https://placehold.co/300x300/f2e8e3/333?text=София" alt="София" class="rounded-full w-32 h-32 mx-auto mb-4 shadow-md">
                        <h3 class="font-bold text-lg">София Георгиева</h3>
                        <p class="text-stone-600">Маникюрист</p>
                    </div>
                     <div class="text-center">
                        <img loading="lazy" src="https://placehold.co/300x300/e6ddd6/333?text=Оливия" alt="Оливия" class="rounded-full w-32 h-32 mx-auto mb-4 shadow-md">
                        <h3 class="font-bold text-lg">Оливия Димитрова</h3>
                        <p class="text-stone-600">Специалист вежди и мигли</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gallery Section -->
        <section id="gallery" class="py-20 bg-white">
            <div class="container mx-auto px-6 text-center">
                <span class="text-orange-500 font-semibold">Галерия</span>
                <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mt-2 mb-12">Вижте нашите трансформации</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <img loading="lazy" src="https://placehold.co/400x500/f2e8e3/333?text=Терапия+лице" alt="Пример за терапия за лице" class="rounded-lg shadow-md w-full h-full object-cover">
                    <img loading="lazy" src="https://placehold.co/400x500/e6ddd6/333?text=Маникюр" alt="Пример за маникюр" class="rounded-lg shadow-md w-full h-full object-cover">
                    <img loading="lazy" src="https://placehold.co/400x500/f0e9e5/333?text=Ламиниране+мигли" alt="Пример за ламиниране на мигли" class="rounded-lg shadow-md w-full h-full object-cover">
                    <img loading="lazy" src="https://placehold.co/400x500/f2e8e3/333?text=Масаж" alt="Пример за масаж" class="rounded-lg shadow-md w-full h-full object-cover">
                </div>
            </div>
        </section>

        <!-- Booking Form Section -->
        <section id="booking" class="py-20">
            <div class="container mx-auto px-6">
                <div class="bg-white p-8 md:p-12 rounded-lg shadow-xl max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl md:text-4xl font-bold text-stone-900">Запази час</h2>
                        <p class="text-stone-600 mt-2">Попълнете формата, за да запазите своя час за преобразяване.</p>
                    </div>
                    <form id="bookingForm" class="space-y-6">
                        <!-- Personal Information -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-stone-700 font-semibold mb-2">Име и фамилия *</label>
                                <input id="name" type="text" required class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-stone-700 font-semibold mb-2">Телефон *</label>
                                <input id="phone" type="tel" required class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                        </div>

                        <div>
                            <label class="block text-stone-700 font-semibold mb-2">Email</label>
                            <input id="email" type="email" class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>

                        <!-- Service Category -->
                        <div>
                            <label class="block text-stone-700 font-semibold mb-2">Категория услуга *</label>
                            <select id="serviceCategory" required class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="">Изберете категория</option>
                                <option value="face">Грижа за лице</option>
                                <option value="body">Грижа за тяло</option>
                                <option value="nails">Маникюр и педикюр</option>
                                <option value="hair-removal">Епилация</option>
                                <option value="eyebrows-lashes">Вежди и мигли</option>
                                <option value="special">Специални процедури</option>
                                <option value="package">Пакетни услуги</option>
                            </select>
                        </div>

                        <!-- Specific Services -->
                        <div id="specificServices" class="hidden">
                            <label class="block text-stone-700 font-semibold mb-2">Конкретна услуга *</label>
                            <select id="serviceSelect" class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="">Изберете услуга</option>
                            </select>
                        </div>

                        <!-- Additional Options -->
                        <div id="additionalOptions" class="hidden space-y-4 p-4 border border-stone-200 rounded-lg bg-stone-50">
                            <div id="faceOptions" class="hidden">
                                <label class="block text-stone-700 font-semibold mb-2">Тип кожа</label>
                                <select id="skinType" class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="">Изберете тип кожа</option>
                                    <option value="normal">Нормална</option>
                                    <option value="dry">Суха</option>
                                    <option value="oily">Мазна</option>
                                    <option value="combination">Комбинирана</option>
                                    <option value="sensitive">Чувствителна</option>
                                    <option value="mature">Зряла</option>
                                </select>
                                <label class="block text-stone-700 font-semibold mb-2 mt-4">Проблеми с кожата</label>
                                <div id="skinProblems" class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center"><input type="checkbox" value="Акне" class="mr-2 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> Акне</label>
                                    <label class="flex items-center"><input type="checkbox" value="Пигментни петна" class="mr-2 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> Пигментни петна</label>
                                    <label class="flex items-center"><input type="checkbox" value="Бръчки" class="mr-2 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> Бръчки</label>
                                    <label class="flex items-center"><input type="checkbox" value="Разширени пори" class="mr-2 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> Разширени пори</label>
                                    <label class="flex items-center"><input type="checkbox" value="Розацеа" class="mr-2 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> Розацеа</label>
                                    <label class="flex items-center"><input type="checkbox" value="Дехидратация" class="mr-2 h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"> Дехидратация</label>
                                </div>
                            </div>
                            <div id="bodyOptions" class="hidden">
                                <label class="block text-stone-700 font-semibold mb-2">Цел на процедурата</label>
                                <select id="bodyGoal" class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="">Изберете цел</option>
                                    <option value="relaxation">Релаксация</option>
                                    <option value="cellulite">Антицелулит</option>
                                    <option value="toning">Тониране</option>
                                    <option value="detox">Детокс</option>
                                    <option value="moisturizing">Хидратация</option>
                                    <option value="slimming">Отслабване</option>
                                </select>
                            </div>
                        </div>

                        <!-- Gemini Recommendation Button -->
                        <div id="gemini-section" class="hidden text-center py-4">
                            <button type="button" id="getRecommendationBtn" class="bg-gradient-to-r from-black to-black text-white px-8 py-3 rounded-lg text-md font-semibold hover:shadow-lg transform hover:scale-105 transition-all">
                                ✨ Генерирай препоръка
                            </button>
                        </div>

                        <!-- Date and Time -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-stone-700 font-semibold mb-2">Предпочитана дата *</label>
                                <input id="bookingDate" type="date" required class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-stone-700 font-semibold mb-2">Предпочитано време</label>
                                <select id="bookingTime" class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                    <option value="">Изберете време</option>
                                    <option value="09:00">09:00</option><option value="09:30">09:30</option>
                                    <option value="10:00">10:00</option><option value="10:30">10:30</option>
                                    <option value="11:00">11:00</option><option value="11:30">11:30</option>
                                    <option value="12:00">12:00</option><option value="12:30">12:30</option>
                                    <option value="13:00">13:00</option><option value="13:30">13:30</option>
                                    <option value="14:00">14:00</option><option value="14:30">14:30</option>
                                    <option value="15:00">15:00</option><option value="15:30">15:30</option>
                                    <option value="16:00">16:00</option><option value="16:30">16:30</option>
                                    <option value="17:00">17:00</option><option value="17:30">17:30</option>
                                    <option value="18:00">18:00</option>
                                </select>
                            </div>
                        </div>

                        <!-- Special Requests -->
                        <div>
                            <label class="block text-stone-700 font-semibold mb-2">Специални изисквания или алергии</label>
                            <textarea id="specialRequests" rows="4" class="w-full px-4 py-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Опишете всички алергии, специални изисквания или допълнителна информация..."></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center pt-6">
                            <button type="submit" id="submitBtn" class="bg-black text-white px-12 py-3 rounded-lg text-lg font-semibold hover:bg-stone-800 transition-all w-full md:w-auto flex items-center justify-center mx-auto">
                                <span id="submitBtnText">Изпрати заявка</span>
                                <div id="submitSpinner" class="spinner hidden ml-3"></div>
                            </button>
                            <p class="text-sm text-stone-500 mt-4">
                                * Ще се свържем с вас в рамките на 24 часа за потвърждение
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-stone-900 text-white">
        <div class="container mx-auto px-6 py-12 grid md:grid-cols-4 gap-8">
            <div>
                <h3 class="text-xl font-bold font-serif mb-4">Velvera</h3>
                <p class="text-stone-400">Модерен салон за красота, посветен на вашето съвършенство.</p>
            </div>
            <div>
                <h4 class="font-semibold text-lg mb-4">Меню</h4>
                <ul class="space-y-2">
                    <li><a href="#services" class="text-stone-400 hover:text-white">Услуги</a></li>
                    <li><a href="#about" class="text-stone-400 hover:text-white">За нас</a></li>
                    <li><a href="#team" class="text-stone-400 hover:text-white">Екип</a></li>
                    <li><a href="#booking" class="text-stone-400 hover:text-white">Контакти</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold text-lg mb-4">Социални мрежи</h4>
                <ul class="space-y-2">
                    <li><a href="#" class="text-stone-400 hover:text-white">Instagram</a></li>
                    <li><a href="#" class="text-stone-400 hover:text-white">Facebook</a></li>
                    <li><a href="#" class="text-stone-400 hover:text-white">Twitter</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-semibold text-lg mb-4">Информация</h4>
                <ul class="space-y-2 text-stone-400">
                    <li><a href="mailto:info@velvera.com" class="hover:text-white">info@velvera.com</a></li>
                    <li><a href="tel:+359888123456" class="hover:text-white">+359 888 123 456</a></li>
                    <li>гр. София, бул. "Витоша" 100</li>
                </ul>
            </div>
        </div>
        <div class="border-t border-stone-800 py-4">
            <p class="text-center text-stone-500 text-sm">&copy; 2024 Velvera. Всички права запазени.</p>
        </div>
    </footer>

    <!-- Universal Modal -->
    <div id="universalModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modalBackdrop" class="absolute inset-0 bg-black bg-opacity-50 modal-backdrop"></div>
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full mx-4 z-10 modal-content transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold font-serif text-stone-900"></h3>
                <button id="closeModalBtn" class="text-stone-500 hover:text-stone-800 text-3xl">&times;</button>
            </div>
            <div id="modalContent" class="text-stone-700 space-y-4">
                <div id="modalSpinner" class="hidden flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-500"></div>
                </div>
                <div id="modalText"></div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        // --- Firebase Initialization ---
        // Директна конфигурация за Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDdHa2fuk4NprrBDn-c4s0N5O-FdQIZSFI",
            authDomain: "beauty-saloon-sofia.firebaseapp.com",
            projectId: "beauty-saloon-sofia",
            storageBucket: "beauty-saloon-sofia.firebasestorage.app",
            messagingSenderId: "371535992409",
            appId: "1:371535992409:web:6ca68dba4bd47a4a438348",
            measurementId: "G-J2HHVGH965"
        };

        let db, auth, analytics;
        try {
            console.log("Инициализиране на Firebase...");
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            
            // Работим без автентикация, така че правилата за Firestore
            // трябва да позволяват публичен достъп до колекцията bookings
            console.log("Firebase инициализиран успешно без изискване за автентикация");
        } catch (error) {
            console.error("Грешка при инициализиране на Firebase:", error.code, error.message);
            const bookingSection = document.getElementById('booking');
            if(bookingSection) {
                 bookingSection.innerHTML = `<div class="text-center text-red-500 p-8 bg-red-100 rounded-lg">Грешка при свързване със системата за резервации: ${error.message}. Моля, опитайте отново по-късно.</div>`;
            }
        }

        // --- DOM Elements ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const serviceCategory = document.getElementById('serviceCategory');
        const specificServices = document.getElementById('specificServices');
        const serviceSelect = document.getElementById('serviceSelect');
        const additionalOptions = document.getElementById('additionalOptions');
        const geminiSection = document.getElementById('gemini-section');
        const bookingForm = document.getElementById('bookingForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitBtnText = document.getElementById('submitBtnText');
        const submitSpinner = document.getElementById('submitSpinner');
        const getRecommendationBtn = document.getElementById('getRecommendationBtn');
        
        // --- Modal Logic ---
        const universalModal = document.getElementById('universalModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalSpinner = document.getElementById('modalSpinner');
        const modalText = document.getElementById('modalText');

        const showModal = (title, content, showSpinner = false) => {
            modalTitle.textContent = title;
            modalText.innerHTML = content || '';
            modalSpinner.classList.toggle('hidden', !showSpinner);
            modalText.classList.toggle('hidden', showSpinner);
            universalModal.classList.remove('hidden');
            setTimeout(() => {
                modalBackdrop.classList.remove('opacity-0');
                universalModal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        };

        const updateModalContent = (content) => {
            modalSpinner.classList.add('hidden');
            modalText.classList.remove('hidden');
            modalText.innerHTML = content;
        }

        const hideModal = () => {
            modalBackdrop.classList.add('opacity-0');
            universalModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => universalModal.classList.add('hidden'), 300);
        };
        closeModalBtn.addEventListener('click', hideModal);
        modalBackdrop.addEventListener('click', hideModal);


        // --- UI Logic ---
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        
        const services = {
            face: ['Класическо почистване на лице', 'Дълбоко почистване с ултразвук', 'Хидратираща терапия', 'Анти-ейдж терапия', 'Микродермабразио', 'Химичен пилинг', 'Диамантено микродермабразио', 'Кислородна терапия', 'Колагенова маска', 'LED светлинна терапия'],
            body: ['Релаксиращ масаж', 'Лечебен масаж', 'Антицелулитен масаж', 'Лимфодренажен масаж', 'Скраб за тяло', 'Обвивка с водорасли', 'Детокс обвивка', 'Хидратираща терапия', 'Кавитация', 'RF лифтинг за тяло'],
            nails: ['Класически маникюр', 'Европейски маникюр', 'Гел лак маникюр', 'Френски маникюр', 'Класически педикюр', 'СПА педикюр', 'Гел лак педикюр', 'Nail art дизайн', 'Укрепване на нокти', 'Парафинова терапия'],
            'hair-removal': ['Восъчна епилация - крака', 'Восъчна епилация - ръце', 'Восъчна епилация - подмишници', 'Восъчна епилация - бикини', 'Лазерна епилация', 'IPL епилация', 'Захарна епилация', 'Епилация с конец', 'Епилация на лице', 'Пълна епилация на тяло'],
            'eyebrows-lashes': ['Оформяне на вежди с конец', 'Оформяне на вежди с восък', 'Боядисване на вежди', 'Ламиниране на вежди', 'Микроблейдинг', 'Удължаване на мигли', 'Ламиниране на мигли', 'Боядисване на мигли', 'Перманентен грим - вежди', 'Перманентен грим - очна линия'],
            special: ['RF лифтинг за лице', 'RF лифтинг за тяло', 'Кавитация', 'Криолиполиза', 'Мезотерапия', 'Плазмолифтинг', 'Хиалуронова терапия', 'Ботокс терапия', 'Фотоподмладяване', 'Карбокситерапия'],
            package: ['Пакет "Красива невеста"', 'Пакет "Релакс уикенд"', 'Пакет "Анти-ейдж"', 'Пакет "Перфектно тяло"', 'Пакет "Експресна красота"', 'Пакет "Луксозна грижа"', 'Месечен абонамент', 'Годишен абонамент']
        };

        serviceCategory.addEventListener('change', function() {
            const category = this.value;
            specificServices.classList.add('hidden');
            additionalOptions.classList.add('hidden');
            geminiSection.classList.add('hidden');
            document.querySelectorAll('#additionalOptions > div').forEach(div => div.classList.add('hidden'));

            if (category) {
                specificServices.classList.remove('hidden');
                serviceSelect.innerHTML = '<option value="">Изберете услуга</option>';
                if (services[category]) {
                    services[category].forEach(service => {
                        const option = new Option(service, service);
                        serviceSelect.appendChild(option);
                    });
                }
                const optionsMap = { 'face': 'faceOptions', 'body': 'bodyOptions' };
                if (optionsMap[category]) {
                    additionalOptions.classList.remove('hidden');
                    geminiSection.classList.remove('hidden');
                    document.getElementById(optionsMap[category]).classList.remove('hidden');
                }
            }
        });

        // --- Form Submission to Firestore ---
        bookingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Подобрена проверка за Firebase услуги
            if (!db) {
                console.error("Firestore DB не е инициализиран.");
                showModal('Грешка при свързване', 'Базата данни не е достъпна. Моля, презаредете страницата и опитайте отново.');
                return;
            }
            
            // Продължаваме с изпращането, дори без автентикация
            console.log("Формата се изпраща...");

            console.log("Започва изпращане на формата:", auth && auth.currentUser ? `Потребител с ID: ${auth.currentUser.uid}` : "Без автентикация");

            submitBtn.disabled = true;
            submitBtnText.textContent = 'Изпращане...';
            submitSpinner.classList.remove('hidden');

            // Проверка за всички задължителни полета
            const name = document.getElementById('name')?.value;
            const phone = document.getElementById('phone')?.value;
            const selectedCategory = serviceCategory?.value;
            const bookingDate = document.getElementById('bookingDate')?.value;
            
            if (!name || !phone || !selectedCategory || !bookingDate) {
                console.error("Липсват задължителни полета във формуляра");
                showModal('Грешка при изпращане', 'Моля, попълнете всички задължителни полета (име, телефон, категория услуга и дата)');
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Изпрати заявка';
                submitSpinner.classList.add('hidden');
                return;
            }
            
            const bookingData = {
                name: name,
                phone: phone,
                email: document.getElementById('email')?.value || '',
                serviceCategory: selectedCategory,
                specificService: serviceSelect?.value || '',
                bookingDate: bookingDate,
                bookingTime: document.getElementById('bookingTime')?.value || '',
                specialRequests: document.getElementById('specialRequests')?.value || '',
                status: 'pending', // Начален статус
                createdAt: serverTimestamp(),
                clientTimestamp: new Date().toISOString(),
                guestId: Date.now().toString() // Уникален идентификатор за проследяване
            };

            try {
                console.log("Опит за добавяне на документ с данни:", bookingData);
                
                // Опростен път към колекцията за запазване на резервациите
                const bookingsRef = collection(db, "bookings");
                console.log("Записване в колекция: bookings");
                
                try {
                    const docRef = await addDoc(bookingsRef, bookingData);
                    console.log("УСПЕХ: Документът е записан с ID: ", docRef.id);
                    showModal('✅ Заявката е изпратена!', 'Благодарим Ви! Вашата заявка за резервация е получена успешно. Ще се свържем с Вас скоро за потвърждение.');
                    bookingForm.reset();
                    if (serviceCategory) {
                        serviceCategory.dispatchEvent(new Event('change')); // Нулиране на зависимите полета
                    }
                } catch (innerError) {
                    console.error("ГРЕШКА ПРИ ЗАПИСВАНЕ:", innerError);
                    throw innerError; // Препращаме грешката нагоре за обработка
                }
            } catch (error) {
                console.error("ГРЕШКА В FIRESTORE:", error);
                
                // По-подробна диагностика
                let errorMessage = 'Възникна неочаквана грешка при изпращането на заявката.';
                let detailedError = '';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Нямате необходимите права за тази операция. Моля, проверете правилата за сигурност в Firebase.';
                    detailedError = 'Трябва да промените правилата за сигурност във Firestore, за да позволите записи без автентикация.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Услугата е временно недостъпна. Моля, проверете вашата интернет връзка.';
                } else if (error.code === 'resource-exhausted') {
                    errorMessage = 'Достигнат е лимитът на заявки към базата данни. Моля, опитайте отново по-късно.';
                }
                
                showModal('❌ Грешка при изпращане', `${errorMessage}<br><br><small>${error.message || 'Няма допълнителна информация'}</small>`);
                
                // Записваме детайлна информация в конзолата за диагностика
                if (detailedError) {
                    console.error("ДЕТАЙЛНА ИНФОРМАЦИЯ:", detailedError);
                }
            } finally {
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Изпрати заявка';
                submitSpinner.classList.add('hidden');
            }
        });

        // --- Gemini AI Recommendation ---
        getRecommendationBtn.addEventListener('click', async () => {
            showModal('✨ Вашата Персонална Препоръка', '', true);

            const category = serviceCategory.value;
            const categoryText = serviceCategory.options[serviceCategory.selectedIndex].text;
            const availableServices = services[category] ? services[category].join(', ') : 'няма налични';
            let details = '';
            if (category === 'face') {
                const skinType = document.getElementById('skinType').value;
                const selectedProblems = Array.from(document.querySelectorAll('#skinProblems input:checked')).map(cb => cb.value);
                details = `Тип на кожата: ${skinType || 'не е посочен'}. Проблеми: ${selectedProblems.length > 0 ? selectedProblems.join(', ') : 'няма посочени'}.`;
            } else if (category === 'body') {
                const bodyGoal = document.getElementById('bodyGoal').value;
                details = `Цел на процедурата: ${bodyGoal || 'не е посочена'}.`;
            }

            const prompt = `Ти си експерт-козметик в луксозен салон за красота. Клиент се интересува от процедура в категория "${categoryText}". Въз основа на следната информация: "${details}", коя от тези налични услуги би препоръчал/а: [${availableServices}]? Дай своята препоръка в следния формат: **Препоръчана процедура:** [Име на процедурата] **Защо е подходяща:** [Кратко и ясно обяснение в 2-3 изречения]. Отговори на български език.`;

            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyDdHa2fuk4NprrBDn-c4s0N5O-FdQIZSFI"; // Заменете със своя Gemini API ключ
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                const recommendationText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Не успяхме да генерираме препоръка.";
                updateModalContent(recommendationText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'));
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                updateModalContent(`<p class="text-red-500">Възникна грешка. Моля, опитайте отново.</p>`);
            }
        });

        const dateInput = document.getElementById('bookingDate');
        if (dateInput) {
            dateInput.setAttribute('min', new Date().toISOString().split('T')[0]);
        }
    </script>
</body>
</html>
